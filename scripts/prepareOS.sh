#!/bin/bash

# /etc/hosts
echo "10.0.0.20  kmaster" >> /etc/hosts
echo "10.0.0.21  kworker1" >> /etc/hosts
echo "10.0.0.22  kworker2" >> /etc/hosts

yum install vim wget yum-utils socat -y

# Disable SELINUX
setenforce 0 # До перезагрузки
sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config # После перезагрузки

# Enable IPv4 packet forwarding
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
EOF
# Apply sysctl params without reboot
sudo sysctl --system

# SSH keys
if [ "$(cat /etc/hostname)" == "kmaster" ]; then
    cat <<EOF | sudo tee /root/.ssh/id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----
EOF
    chmod 600 /root/.ssh/id_rsa
else
    cat <<EOF | sudo tee /root/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDN9dI/o5h7IVkr1XjIRm7iQ5yv1iQrlBWsbnxOkqmZemOqKlOgxsMeShQXNxydgGPVI55PlonU73apzlViNZL05gPIBz5URGiFyC7pXNyyxcFXJVNm8eX4TgSWPLiDVsiNN2kfFGuOFkTpc7vRsQTNYhBo4h2ym6f/uBOC+8+W+VWxvc2mwSGdpTTHfomZl0ZWF9P0z8eGmWMJVqfZQw2L/4qh4XILASsqosKP2X56xOLTkGS18TJAUmAbyNNblrG8rRLDCEQ2B0ZDcfjuYD7E6gG4aW6y2w6MyII0aWGLDp+xBRZtoyzllmoTtyyVOvx5MSxoEm7BW97E6ycWhMv+/V/Rb1knB6HVD4fJ1IRv/Kn/rXe0MIGsDRKfaL5Hw1SiDna+GYqvbV7T277CJgtfr6shJNXGW7uBJp3EB3d5bK8uoMhLvHzK9UFoiiphLLbqsgsoEr1i9O0dLFAct2rFvkMcIDAZaFciY6Ba8Ji4K/pSgsNKhbtBv20dgXR9DHs= root@kmaster
EOF
fi

systemctl restart sshd
